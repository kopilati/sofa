version: '3'

vars:
  CLUSTER_NAME: sofa-test
  IMAGE_NAME: sofa:latest
  AUDIT_IMAGE_NAME: audit-service:latest
  NAMESPACE: default
  SOFA_PORT: 30081
  KEYCLOAK_PORT: 30082
  AUDIT_PORT: 30083
  ENVIRONMENT: dev # default environment
  SOFA_URL: http://localhost:{{.SOFA_PORT}}

tasks:
  build:
    desc: Build the Sofa Docker image
    cmds:
    - echo "Building Sofa Docker image..."
    - docker build -t {{.IMAGE_NAME}} ./sofa

  build-audit:
    desc: Build the Audit Service Docker image
    cmds:
    - echo "Building Audit Service Docker image..."
    - docker build -t {{.AUDIT_IMAGE_NAME}} ./audit-service

  rollout:
    desc: Build Sofa, load the image into Kind, and rollout the deployment
    cmds:
    - echo "Building and rolling out Sofa..."
    - task: build
    - kind load docker-image {{.IMAGE_NAME}} --name {{.CLUSTER_NAME}}
    - kubectl rollout restart deployment/{{.ENVIRONMENT}}-sofa
    - kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-sofa --timeout=60s
    - echo "Sofa has been rebuilt and deployed"

  rollout-audit:
    desc: Build Audit Service, load the image into Kind, and rollout the deployment
    cmds:
    - echo "Building and rolling out Audit Service..."
    - task: build-audit
    - kind load docker-image {{.AUDIT_IMAGE_NAME}} --name {{.CLUSTER_NAME}}
    - kubectl apply -f ./audit-service/k8s/audit-service.yaml
    - kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-audit-service --timeout=60s
    - echo "Audit Service has been rebuilt and deployed"

  port-forward-audit:
    desc: Set up port forwarding for Audit Service only
    cmds:
    - |
      echo "Setting up port forwarding for Audit Service..."
      echo "Audit Service will be available at: http://localhost:{{.AUDIT_PORT}}"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      kubectl port-forward svc/{{.ENVIRONMENT}}-audit-service {{.AUDIT_PORT}}:80

  create-cluster:
    desc: Create a Kind cluster if it doesn't exist
    cmds:
    - |
      if ! kind get clusters | grep -q {{.CLUSTER_NAME}}; then
        echo "Creating Kind cluster..."
        kind create cluster --name {{.CLUSTER_NAME}} --config kind-config.yaml
      else
        echo "Kind cluster already exists, skipping creation."
      fi

  load-image:
    desc: Load the Sofa image into the Kind cluster
    deps: [ build, create-cluster ]
    cmds:
    - echo "Loading Sofa image into Kind cluster..."
    - kind load docker-image {{.IMAGE_NAME}} --name {{.CLUSTER_NAME}}

  load-audit-image:
    desc: Load the Audit Service image into the Kind cluster
    deps: [ build-audit, create-cluster ]
    cmds:
    - echo "Loading Audit Service image into Kind cluster..."
    - kind load docker-image {{.AUDIT_IMAGE_NAME}} --name {{.CLUSTER_NAME}}

  apply-manifests:
    desc: Apply all Kubernetes manifests using Kustomize
    deps: [ load-image ]
    cmds:
    - echo "Applying Kubernetes resources using Kustomize for {{.ENVIRONMENT}} environment..."
    - kubectl apply -k k8s/overlays/{{.ENVIRONMENT}}
    - |
      echo "Waiting for services to be ready..."
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-couchdb --timeout=90s || true
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-sofa --timeout=90s || true
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-keycloak --timeout=120s || true

      echo "Services are available in the cluster. Use port-forwarding to access them."
      echo "Run 'task port-forward' to access the services."

  enable-audit:
    desc: Enable audit logging in SOFA by configuring it to use the audit service
    cmds:
    - |
      echo "Patching SOFA configuration to enable audit logging..."
      kubectl patch configmap {{.ENVIRONMENT}}-sofa-config -p '{"data":{"audit_enabled":"true","audit_log_service_url":"http://{{.ENVIRONMENT}}-audit-service/audit"}}'
      echo "Restarting SOFA to apply changes..."
      kubectl rollout restart deployment/{{.ENVIRONMENT}}-sofa
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-sofa --timeout=60s
      echo "Audit logging has been enabled in SOFA"

  port-forward:
    desc: Set up port forwarding for both Sofa and Keycloak
    cmds:
    - |
      echo "Setting up port forwarding for Sofa and Keycloak..."
      echo "Sofa will be available at: http://localhost:{{.SOFA_PORT}}"
      echo "Keycloak will be available at: http://localhost:{{.KEYCLOAK_PORT}}"
      echo "Keycloak admin console: http://localhost:{{.KEYCLOAK_PORT}}/admin (admin/admin)"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      echo ""

      # Start port forwards in background
      kubectl port-forward svc/{{.ENVIRONMENT}}-sofa-service {{.SOFA_PORT}}:80 & 
      SOFA_PF_PID=$!

      kubectl port-forward svc/{{.ENVIRONMENT}}-keycloak-service {{.KEYCLOAK_PORT}}:8080 &
      KC_PF_PID=$!

      # Set up trap to kill background processes on exit
      trap "kill $SOFA_PF_PID $KC_PF_PID" EXIT INT TERM

      # Keep script running
      echo "Port forwarding active. Press Ctrl+C to exit."
      tail -f /dev/null

  port-forward-all:
    desc: Set up port forwarding for Sofa, Keycloak, and Audit Service
    cmds:
    - |
      echo "Setting up port forwarding for Sofa, Keycloak, and Audit Service..."
      echo "Sofa will be available at: http://localhost:{{.SOFA_PORT}}"
      echo "Keycloak will be available at: http://localhost:{{.KEYCLOAK_PORT}}"
      echo "Audit Service will be available at: http://localhost:{{.AUDIT_PORT}}"
      echo "Keycloak admin console: http://localhost:{{.KEYCLOAK_PORT}}/admin (admin/admin)"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      echo ""

      # Start port forwards in background
      kubectl port-forward svc/{{.ENVIRONMENT}}-sofa-service {{.SOFA_PORT}}:80 & 
      SOFA_PF_PID=$!

      kubectl port-forward svc/{{.ENVIRONMENT}}-keycloak-service {{.KEYCLOAK_PORT}}:8080 &
      KC_PF_PID=$!

      kubectl port-forward svc/{{.ENVIRONMENT}}-audit-service {{.AUDIT_PORT}}:80 &
      AUDIT_PF_PID=$!

      # Set up trap to kill background processes on exit
      trap "kill $SOFA_PF_PID $KC_PF_PID $AUDIT_PF_PID" EXIT INT TERM

      # Keep script running
      echo "Port forwarding active. Press Ctrl+C to exit."
      tail -f /dev/null

  port-forward-sofa:
    desc: Set up port forwarding for Sofa only
    cmds:
    - |
      echo "Setting up port forwarding for Sofa..."
      echo "Sofa will be available at: http://localhost:{{.SOFA_PORT}}"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      kubectl port-forward svc/{{.ENVIRONMENT}}-sofa-service {{.SOFA_PORT}}:80

  port-forward-keycloak:
    desc: Set up port forwarding for Keycloak only
    cmds:
    - |
      echo "Setting up port forwarding for Keycloak..."
      echo "Keycloak will be available at: http://localhost:{{.KEYCLOAK_PORT}}"
      echo "Keycloak admin console: http://localhost:{{.KEYCLOAK_PORT}}/admin (admin/admin)"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      kubectl port-forward svc/{{.ENVIRONMENT}}-keycloak-service {{.KEYCLOAK_PORT}}:8080

  setup:
    desc: Complete setup - build, create cluster, load image, and apply manifests
    deps: [ load-image, apply-manifests ]
    cmds:
    - |
      # Skip Keycloak connectivity checks during setup for now
      echo "Setup complete!"
      echo "To access the services, run: task port-forward"
      echo ""
      echo "Services will be available at:"
      echo "  - Sofa: http://localhost:{{.SOFA_PORT}}"
      echo "  - Keycloak: http://localhost:{{.KEYCLOAK_PORT}}"
      echo ""
      echo "Keycloak admin console will be available at:"
      echo "  http://localhost:{{.KEYCLOAK_PORT}}/admin"
      echo "  Username: admin"
      echo "  Password: admin"

  setup-audit:
    desc: Setup and deploy the audit service
    deps: [ load-audit-image ]
    cmds:
    - |
      echo "Applying Audit Service manifests..."
      kubectl apply -f ./audit-service/k8s/audit-service.yaml
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-audit-service --timeout=60s
      echo "Audit Service setup complete! Run 'task enable-audit' to configure SOFA to use it."
      echo "You can access the Audit Service at: http://localhost:{{.AUDIT_PORT}} (after running port-forward-audit)"

  keycloak-ready:
    desc: Check if Keycloak is ready and properly configured
    deps: [ apply-manifests ]
    cmds:
    - |
      echo "Checking if Keycloak is ready..."
      # Wait for keycloak to be available
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-keycloak --timeout=120s || true
      echo "To access Keycloak admin console, run: task port-forward-keycloak"
      echo "Then access: http://localhost:{{.KEYCLOAK_PORT}}/admin"
      echo "Username: admin"
      echo "Password: admin"

  switch-env:
    desc: Switch the active environment (dev, test, prod)
    interactive: true
    cmds:
    - |
      if [ -z "{{.CLI_ARGS}}" ]; then
        echo "Usage: task switch-env -- [dev|test|prod]"
        exit 1
      fi

      if [ "{{.CLI_ARGS}}" != "dev" ] && [ "{{.CLI_ARGS}}" != "test" ] && [ "{{.CLI_ARGS}}" != "prod" ]; then
        echo "Invalid environment. Please specify one of: dev, test, prod"
        exit 1
      fi

      # Create a temporary file with updated vars
      cat > .env.temp << EOF
      ENVIRONMENT={{.CLI_ARGS}}
      EOF

      echo "Environment switched to {{.CLI_ARGS}}"

      # Prompt to apply changes immediately
      read -p "Do you want to apply changes immediately? (y/n) " apply
      if [ "$apply" = "y" ] || [ "$apply" = "Y" ]; then
        task apply-manifests ENVIRONMENT={{.CLI_ARGS}}
      fi

  show-env:
    desc: Show the current environment
    cmds:
    - |
      echo "Current environment: {{.ENVIRONMENT}}"

  # CouchDB Operations Tasks
  create-database:
    silent: false
    desc: Create a database in CouchDB using direct curl command
    cmds:
    - |
      # Parse arguments
      if [ -z "{{.CLI_ARGS}}" ]; then
        echo "Usage: task create-database-simple -- <database_name>"
        exit 1
      fi

      DB_NAME={{.CLI_ARGS}}
      echo "Creating database '$DB_NAME'..."

      CLIENT_ID="sofa-client"
      CLIENT_SECRET="sofa-client-secret"

      # Get token from Keycloak
      echo "Getting token from Keycloak..."
      TOKEN_RESPONSE=$(curl -s -X POST \
        "http://localhost:30082/realms/sofa/protocol/openid-connect/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET")

      echo "Token response: $TOKEN_RESPONSE"

      ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

      if [ -z "$ACCESS_TOKEN" ]; then
        echo "‚ùå Failed to get access token"
        exit 1
      fi

      echo "‚úÖ Got access token"
      echo "First 100 chars of token: ${ACCESS_TOKEN:0:100}..."

      # Directly create database
      echo "Creating database with curl..."
      curl -v -X PUT \
        "http://localhost:30081/$DB_NAME" \
        -H "Authorization: Bearer $ACCESS_TOKEN"

  insert-document:
    desc: Insert a document into a CouchDB database (requires port-forwarding)
    cmds:
    - |
      # Parse arguments
      args=({{.CLI_ARGS}})
      if [ ${#args[@]} -lt 2 ]; then
        echo "Usage: task insert-document -- <database_name> '<json_document>'"
        echo "Example: task insert-document -- my_database '{\"name\":\"John\",\"age\":30}'"
        exit 1
      fi

      DB_NAME=${args[0]}
      JSON_DATA=${args[@]:1}

      # Check if database exists
      echo "Checking if database '$DB_NAME' exists..."
      DB_CHECK=$(curl -s -o /dev/null -w "%{http_code}" "{{.SOFA_URL}}/$DB_NAME")

      if [ "$DB_CHECK" != "200" ]; then
        echo "Database '$DB_NAME' doesn't exist. Creating it..."
        CREATE_RESPONSE=$(curl -s -X PUT "{{.SOFA_URL}}/$DB_NAME" -w "\n%{http_code}")
        CREATE_HTTP_CODE=$(echo "$CREATE_RESPONSE" | tail -n1)
        
        if [ "$CREATE_HTTP_CODE" != "201" ] && [ "$CREATE_HTTP_CODE" != "412" ]; then
          echo "‚ùå Failed to create database '$DB_NAME'"
          echo "HTTP Code: $CREATE_HTTP_CODE"
          echo "Response: $(echo "$CREATE_RESPONSE" | sed '$d')"
          exit 1
        fi
      fi

      # Insert the document
      echo "Inserting document into '$DB_NAME'..."
      RESPONSE=$(curl -s -X POST "{{.SOFA_URL}}/$DB_NAME" \
        -H "Content-Type: application/json" \
        -d "$JSON_DATA" \
        -w "\n%{http_code}")

      HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | sed '$d')

      if [ "$HTTP_CODE" = "201" ]; then
        # Extract document ID from response
        DOC_ID=$(echo "$BODY" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
        echo "‚úÖ Document inserted successfully"
        echo "Document ID: $DOC_ID"
        echo "Full response: $BODY"
        echo "$DOC_ID"  # Output just the ID for easy capture
      else
        echo "‚ùå Failed to insert document"
        echo "HTTP Code: $HTTP_CODE"
        echo "Response: $BODY"
        exit 1
      fi

  retrieve-document:
    desc: Retrieve a document from CouchDB (requires port-forwarding)
    cmds:
    - |
      # Parse arguments
      args=({{.CLI_ARGS}})
      if [ ${#args[@]} -lt 2 ]; then
        echo "Usage: task retrieve-document -- <database_name> <document_id>"
        echo "Example: task retrieve-document -- my_database 1234567890abcdef"
        exit 1
      fi

      DB_NAME=${args[0]}
      DOC_ID=${args[1]}

      # Retrieve the document
      echo "Retrieving document '$DOC_ID' from database '$DB_NAME'..."
      RESPONSE=$(curl -s -X GET "{{.SOFA_URL}}/$DB_NAME/$DOC_ID" \
        -w "\n%{http_code}")

      HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | sed '$d')

      if [ "$HTTP_CODE" = "200" ]; then
        echo "‚úÖ Document retrieved successfully"
        echo "$BODY" | json_pp  # Pretty print the JSON response
      elif [ "$HTTP_CODE" = "404" ]; then
        echo "‚ùå Document not found"
        echo "Response: $BODY"
        exit 1
      else
        echo "‚ùå Failed to retrieve document"
        echo "HTTP Code: $HTTP_CODE"
        echo "Response: $BODY"
        exit 1
      fi

  round-trip:
    desc: Perform a round-trip operation (create DB, insert document, retrieve document)
    cmds:
    - |
      # Parse arguments
      args=({{.CLI_ARGS}})
      if [ ${#args[@]} -lt 2 ]; then
        echo "Usage: task round-trip -- <database_name> '<json_document>'"
        echo "Example: task round-trip -- my_database '{\"name\":\"John\",\"age\":30}'"
        exit 1
      fi

      DB_NAME=${args[0]}
      JSON_DATA=${args[@]:1}

      echo "üîÑ Starting round-trip test..."
      echo "========================================"

      # Step 1: Ensure the database exists
      echo "Step 1: Creating/checking database '$DB_NAME'..."
      DB_RESPONSE=$(curl -s -X PUT "{{.SOFA_URL}}/$DB_NAME" -w "\n%{http_code}")
      DB_HTTP_CODE=$(echo "$DB_RESPONSE" | tail -n1)
      DB_BODY=$(echo "$DB_RESPONSE" | sed '$d')

      if [ "$DB_HTTP_CODE" = "201" ]; then
        echo "‚úÖ Database '$DB_NAME' created"
      elif [ "$DB_HTTP_CODE" = "412" ]; then
        echo "‚úÖ Database '$DB_NAME' already exists"
      else
        echo "‚ùå Failed to create database"
        echo "HTTP Code: $DB_HTTP_CODE"
        echo "Response: $DB_BODY"
        exit 1
      fi

      echo "========================================"

      # Step 2: Insert the document
      echo "Step 2: Inserting document into '$DB_NAME'..."
      INSERT_RESPONSE=$(curl -s -X POST "{{.SOFA_URL}}/$DB_NAME" \
        -H "Content-Type: application/json" \
        -d "$JSON_DATA" \
        -w "\n%{http_code}")

      INSERT_HTTP_CODE=$(echo "$INSERT_RESPONSE" | tail -n1)
      INSERT_BODY=$(echo "$INSERT_RESPONSE" | sed '$d')

      if [ "$INSERT_HTTP_CODE" != "201" ]; then
        echo "‚ùå Failed to insert document"
        echo "HTTP Code: $INSERT_HTTP_CODE"
        echo "Response: $INSERT_BODY"
        exit 1
      fi

      # Extract document ID from response
      DOC_ID=$(echo "$INSERT_BODY" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
      echo "‚úÖ Document inserted with ID: $DOC_ID"
      echo "Original document: $JSON_DATA"

      echo "========================================"

      # Step 3: Retrieve the document
      echo "Step 3: Retrieving document '$DOC_ID'..."
      GET_RESPONSE=$(curl -s -X GET "{{.SOFA_URL}}/$DB_NAME/$DOC_ID" \
        -w "\n%{http_code}")

      GET_HTTP_CODE=$(echo "$GET_RESPONSE" | tail -n1)
      GET_BODY=$(echo "$GET_RESPONSE" | sed '$d')

      if [ "$GET_HTTP_CODE" != "200" ]; then
        echo "‚ùå Failed to retrieve document"
        echo "HTTP Code: $GET_HTTP_CODE"
        echo "Response: $GET_BODY"
        exit 1
      fi

      echo "‚úÖ Document retrieved successfully"
      echo "Retrieved document:"
      echo "$GET_BODY" | json_pp  # Pretty print the JSON

      echo "========================================"
      echo "‚úÖ Round-trip test completed successfully!"

      # Return the document ID
      echo "Document ID: $DOC_ID"

  # Sample document creation task
  create-sample-document:
    desc: Create a sample JSON document that can be used with other tasks
    cmds:
    - |
      cat > sample-document.json << EOF
      {
        "name": "John Doe",
        "email": "john.doe@example.com",
        "age": 30,
        "active": true,
        "roles": ["admin", "user"],
        "address": {
          "street": "123 Main St",
          "city": "Anytown",
          "state": "CA",
          "zip": "12345"
        },
        "created_at": "2023-08-15T10:00:00Z"
      }
      EOF
      echo "‚úÖ Sample document created: sample-document.json"
      echo "Usage examples:"
      echo "  - task insert-document -- my_database \"`cat sample-document.json`\""
      echo "  - task round-trip -- my_database \"`cat sample-document.json`\""

  fix-keycloak-jwks:
    desc: Fix Keycloak JWKS configuration and restart the Keycloak pod
    cmds:
    - |
      echo "Fixing Keycloak JWKS configuration..."

      # Apply the updated Keycloak deployment with JWKS configuration
      kubectl apply -f k8s/base/keycloak/deployment.yaml

      # Restart the Keycloak pod to apply the changes
      echo "Restarting Keycloak pod..."
      kubectl rollout restart deployment/{{.ENVIRONMENT}}-keycloak

      # Wait for the Keycloak pod to be ready
      echo "Waiting for Keycloak to restart (this might take a minute)..."
      kubectl rollout status deployment/{{.ENVIRONMENT}}-keycloak --timeout=120s

      # Check if port-forwarding is active for Keycloak
      if ! ps aux | grep -v grep | grep "kubectl port-forward.*{{.ENVIRONMENT}}-keycloak-service.*{{.KEYCLOAK_PORT}}:8080" > /dev/null; then
        echo "Starting Keycloak port-forwarding..."
        kubectl port-forward svc/{{.ENVIRONMENT}}-keycloak-service {{.KEYCLOAK_PORT}}:8080 > /dev/null 2>&1 &
        echo "‚úÖ Started Keycloak port-forwarding"
        
        # Give it a moment to establish
        sleep 5
      else
        echo "Keycloak port-forwarding is already active"
      fi

      # Check connectivity to Keycloak
      echo "Checking Keycloak connectivity..."
      for i in {1..12}; do
        echo -n "."
        sleep 5
        curl -s --connect-timeout 3 -o /dev/null http://localhost:{{.KEYCLOAK_PORT}} 2>/dev/null
        if [ $? -eq 0 ]; then
          echo " connected!"
          echo "‚úÖ Keycloak is now available at http://localhost:{{.KEYCLOAK_PORT}}"
          echo "‚úÖ Admin console available at http://localhost:{{.KEYCLOAK_PORT}}/admin"
          echo "   Username: admin"
          echo "   Password: admin"
          break
        fi
        
        # If we've reached the last attempt, show more detailed diagnostics
        if [ $i -eq 12 ]; then
          echo ""
          echo "‚ö†Ô∏è Could not connect to Keycloak after multiple attempts."
          echo "Checking Keycloak pod status:"
          kubectl get pods | grep keycloak
          echo ""
          echo "Keycloak logs (last 20 lines):"
          kubectl logs $(kubectl get pods -l app=keycloak -o name | head -1) | tail -20
        fi
      done

      echo ""
      echo "To use the fixed Keycloak with database creation, run:"
      echo "task create-database -- <database_name>"

  fix-keycloak-realm:
    desc: Fix the Keycloak realm configuration and restart Keycloak
    cmds:
    - |
      echo "Applying fixed Keycloak configuration..."

      # Apply the updated Keycloak configuration with proper realm name
      kubectl apply -k k8s/overlays/{{.ENVIRONMENT}}

      # Restart the Keycloak pod to apply the changes
      echo "Restarting Keycloak pod..."
      kubectl rollout restart deployment/{{.ENVIRONMENT}}-keycloak

      # Wait for the Keycloak pod to be ready
      echo "Waiting for Keycloak to restart (this might take a minute)..."
      kubectl rollout status deployment/{{.ENVIRONMENT}}-keycloak --timeout=120s || true

      echo "Waiting for Keycloak to fully initialize (30 seconds)..."
      sleep 30

      echo "‚úÖ Keycloak configuration has been fixed."
      echo "Now you can run 'task setup' again to complete the setup process."

  fix-sofa-jwks:
    desc: Fix the JWKS configuration in Sofa to correctly validate tokens from Keycloak
    cmds:
    - |
      echo "Applying fixed Sofa configuration with correct JWKS URL..."

      # Apply only the Sofa ConfigMap
      kubectl apply -f k8s/overlays/{{.ENVIRONMENT}}/sofa-config-patch.yaml

      # Restart the Sofa pod to apply the changes
      echo "Restarting Sofa pod..."
      kubectl rollout restart deployment/{{.ENVIRONMENT}}-sofa

      # Wait for the Sofa pod to be ready
      echo "Waiting for Sofa to restart..."
      kubectl rollout status deployment/{{.ENVIRONMENT}}-sofa --timeout=60s

      echo "‚úÖ Sofa JWKS configuration has been fixed."
      echo "To create a database, run:"
      echo "task create-database -- <database_name>"
      echo ""
      echo "If you encounter connection issues with Keycloak, you can try:"
      echo "1. Run 'task port-forward' in a separate terminal first"
      echo "2. Try 'task create-database -- <database_name> --skip-checks'"

  default:
    desc: Display help information
    cmds:
    - task --list

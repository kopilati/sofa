version: '3'

vars:
  CLUSTER_NAME: sofa-test
  IMAGE_NAME: sofa:latest
  AUDIT_IMAGE_NAME: audit-service:latest
  HSM_IMAGE_NAME: hsm-simulator:latest
  NAMESPACE: default
  SOFA_PORT: 30081
  KEYCLOAK_PORT: 30082
  AUDIT_PORT: 30083
  HSM_PORT: 30084
  ENVIRONMENT: dev # default environment
  SOFA_URL: http://localhost:{{.SOFA_PORT}}

tasks:
  # Build tasks
  build-sofa:
    desc: Build the Sofa Docker image (with HSM simulator by default)
    cmds:
    - echo "Building Sofa Docker image with HSM simulator..."
    - docker build -t {{.IMAGE_NAME}} ./sofa

  build-azure:
    desc: Build the Sofa Docker image with Azure HSM support
    cmds:
    - echo "Building Sofa Docker image with Azure HSM support..."
    - docker build -t sofa-azure:latest -f ./sofa/Dockerfile.azure ./sofa

  build-audit:
    desc: Build the Audit Service Docker image
    cmds:
    - echo "Building Audit Service Docker image..."
    - docker build -t {{.AUDIT_IMAGE_NAME}} ./audit-service

  build-hsm:
    desc: Build the HSM Simulator Docker image
    cmds:
    - echo "Building HSM Simulator Docker image..."
    - docker build -t {{.HSM_IMAGE_NAME}} ./hsm-simulator

  # Generic build task that builds all services
  build:
    desc: Build all Docker images (Sofa, Audit, HSM)
    deps: [ build-sofa, build-audit, build-hsm ]
    cmds:
    - echo "All services built successfully"

  # Rollout tasks
  rollout-sofa:
    desc: Build Sofa, load the image into Kind, and rollout the deployment
    cmds:
    - echo "Building and rolling out Sofa..."
    - task: build-sofa
    - kind load docker-image {{.IMAGE_NAME}} --name {{.CLUSTER_NAME}}
    - kubectl rollout restart deployment/{{.ENVIRONMENT}}-sofa
    - kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-sofa --timeout=60s
    - echo "Sofa has been rebuilt and deployed"

  rollout-audit:
    desc: Build Audit Service, load the image into Kind, and rollout the deployment
    cmds:
    - echo "Building and rolling out Audit Service..."
    - task: build-audit
    - kind load docker-image {{.AUDIT_IMAGE_NAME}} --name {{.CLUSTER_NAME}}
    - kubectl apply -f ./audit-service/k8s/audit-service.yaml
    - kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-audit-service --timeout=60s
    - echo "Audit Service has been rebuilt and deployed"

  rollout-hsm:
    desc: Build HSM Simulator, load the image into Kind, and rollout the deployment
    cmds:
    - echo "Building and rolling out HSM Simulator..."
    - task: build-hsm
    - kind load docker-image {{.HSM_IMAGE_NAME}} --name {{.CLUSTER_NAME}}
    - kubectl rollout restart deployment/{{.ENVIRONMENT}}-hsm-simulator
    - kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-hsm-simulator --timeout=60s
    - echo "HSM Simulator has been rebuilt and deployed"

  rollout-azure:
    desc: Build Sofa with Azure HSM support, load the image into Kind, and rollout the deployment
    cmds:
    - echo "Building and rolling out Sofa with Azure HSM..."
    - task: build-azure
    - kind load docker-image sofa-azure:latest --name {{.CLUSTER_NAME}}
    - |
      echo "Updating deployment to use Azure HSM image..."
      kubectl set image deployment/{{.ENVIRONMENT}}-sofa sofa=sofa-azure:latest
    - kubectl rollout restart deployment/{{.ENVIRONMENT}}-sofa
    - kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-sofa --timeout=60s
    - echo "Sofa has been rebuilt with Azure HSM support and deployed"

  # Generic rollout task that rolls out all services
  rollout:
    desc: Build and rollout all services (Sofa, Audit, HSM)
    deps: [ rollout-sofa, rollout-audit, rollout-hsm ]
    cmds:
    - echo "All services have been rolled out"

  # Port forwarding tasks
  port-forward-audit:
    desc: Set up port forwarding for Audit Service only
    cmds:
    - |
      echo "Setting up port forwarding for Audit Service..."
      echo "Audit Service will be available at: http://localhost:{{.AUDIT_PORT}}"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      kubectl port-forward svc/{{.ENVIRONMENT}}-audit-service {{.AUDIT_PORT}}:80

  port-forward-hsm:
    desc: Set up port forwarding for HSM Simulator only
    cmds:
    - |
      echo "Setting up port forwarding for HSM Simulator..."
      echo "HSM Simulator will be available at: http://localhost:{{.HSM_PORT}}"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      kubectl port-forward svc/{{.ENVIRONMENT}}-hsm-simulator {{.HSM_PORT}}:8080

  port-forward-sofa:
    desc: Set up port forwarding for Sofa only
    cmds:
    - |
      echo "Setting up port forwarding for Sofa..."
      echo "Sofa will be available at: http://localhost:{{.SOFA_PORT}}"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      kubectl port-forward svc/{{.ENVIRONMENT}}-sofa-service {{.SOFA_PORT}}:80

  port-forward-keycloak:
    desc: Set up port forwarding for Keycloak only
    cmds:
    - |
      echo "Setting up port forwarding for Keycloak..."
      echo "Keycloak will be available at: http://localhost:{{.KEYCLOAK_PORT}}"
      echo "Keycloak admin console: http://localhost:{{.KEYCLOAK_PORT}}/admin (admin/admin)"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      kubectl port-forward svc/{{.ENVIRONMENT}}-keycloak-service {{.KEYCLOAK_PORT}}:8080

  get-token:
    desc: Get an access token from Keycloak using sofa-client credentials
    cmds:
    - |
      # Define variables
      CLIENT_ID="sofa-client"
      CLIENT_SECRET="sofa-client-secret"
      TOKEN_ENDPOINT="http://localhost:{{.KEYCLOAK_PORT}}/realms/sofa/protocol/openid-connect/token"

      # Make token request using client credentials grant
      TOKEN_RESPONSE=$(curl -s -X POST \
        "$TOKEN_ENDPOINT" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET")

      # Check if we got a valid response
      if echo "$TOKEN_RESPONSE" | grep -q "access_token"; then
        # Extract and display the token
        echo "$TOKEN_RESPONSE" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4
        
      else
        echo "❌ Failed to obtain access token"
        echo "Error response: $TOKEN_RESPONSE"
        exit 1
      fi

  create-database:
    desc: Create a database in CouchDB through the Sofa proxy
    cmds:
    - |
      # Check if a database name was provided
      if [ -z "{{.CLI_ARGS}}" ]; then
        echo "❌ Error: Database name is required"
        echo "Usage: task create-database -- <database_name>"
        exit 1
      fi

      DB_NAME="{{.CLI_ARGS}}"
      echo "Creating database '$DB_NAME' through Sofa..."

      ACCESS_TOKEN=$(task get-token)
      # Create the database
      echo "Creating database..."
      RESPONSE=$(curl -s -X PUT \
        "http://localhost:{{.SOFA_PORT}}/$DB_NAME" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -w "\n%{http_code}")

      # Extract HTTP status code and response body
      STATUS_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | sed '$d')

      # Check response status
      if [ "$STATUS_CODE" = "201" ]; then
        echo "✅ Database '$DB_NAME' created successfully"
      elif [ "$STATUS_CODE" = "412" ]; then
        echo "ℹ️ Database '$DB_NAME' already exists"
      else
        echo "❌ Failed to create database"
        echo "Status code: $STATUS_CODE"
        echo "Response: $BODY"
        exit 1
      fi

  insert-document:
    desc: Insert a document into a CouchDB database through the Sofa proxy
    silent: true
    cmds:
    - |
      # Parse arguments
      args=({{.CLI_ARGS}})
      if [ ${#args[@]} -lt 2 ]; then
        echo "❌ Error: Both database name and document data are required"
        echo "Usage: task insert-document -- <database_name> <json_file_or_string>"
        echo "Examples:"
        echo "  task insert-document -- mydb '{\"name\":\"John\",\"age\":30}'"
        echo "  task insert-document -- mydb ./document.json"
        exit 1
      fi

      DB_NAME=${args[0]}
      DOC_SOURCE=${args[@]:1}

      # Determine if the second argument is a file or a JSON string
      JSON_DATA=""
      if [[ -f "$DOC_SOURCE" ]]; then
        echo "Reading JSON from file: $DOC_SOURCE"
        JSON_DATA=$(cat "$DOC_SOURCE")
      else
        echo "Using provided JSON string"
        JSON_DATA="$DOC_SOURCE"
      fi
      ACCESS_TOKEN=$(task get-token)
      # Validate JSON
      echo "$JSON_DATA" | jq . > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        echo "❌ Error: Invalid JSON data"
        echo "Please provide valid JSON or a path to a valid JSON file"
        exit 1
      fi

      echo "Inserting document into database '$DB_NAME'..."

      # Insert the document
      echo "Inserting document... '$ACCESS_TOKEN'"
      RESPONSE=$(curl -s -X POST \
        "http://localhost:{{.SOFA_PORT}}/$DB_NAME" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        -d "$JSON_DATA" \
        -w "\n%{http_code}")

      # Extract HTTP status code and response body
      STATUS_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | sed '$d')

      # Check response status
      if [ "$STATUS_CODE" = "201" ]; then
        # Extract document ID and rev from response
        DOC_ID=$(echo "$BODY" | jq -r '.id')
        DOC_REV=$(echo "$BODY" | jq -r '.rev')
        
        echo "✅ Document inserted successfully"
        echo "Document ID: $DOC_ID"
        echo "Revision: $DOC_REV"
      else
        echo "❌ Failed to insert document"
        echo "Status code: $STATUS_CODE"
        echo "Response: $BODY"
        exit 1
      fi

  # Main port-forward setups that combine multiple services
  port-forward:
    desc: Set up port forwarding for both Sofa and Keycloak
    cmds:
    - |
      echo "Setting up port forwarding for Sofa and Keycloak..."
      echo "Sofa will be available at: http://localhost:{{.SOFA_PORT}}"
      echo "Keycloak will be available at: http://localhost:{{.KEYCLOAK_PORT}}"
      echo "Keycloak admin console: http://localhost:{{.KEYCLOAK_PORT}}/admin (admin/admin)"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      echo ""

      # Start port forwards in background
      kubectl port-forward svc/{{.ENVIRONMENT}}-sofa-service {{.SOFA_PORT}}:80 & 
      SOFA_PF_PID=$!

      kubectl port-forward svc/{{.ENVIRONMENT}}-keycloak-service {{.KEYCLOAK_PORT}}:8080 &
      KC_PF_PID=$!

      # Set up trap to kill background processes on exit
      trap "kill $SOFA_PF_PID $KC_PF_PID" EXIT INT TERM

      # Keep script running
      echo "Port forwarding active. Press Ctrl+C to exit."
      tail -f /dev/null

  port-forward-all:
    desc: Set up port forwarding for Sofa, Keycloak, Audit Service, and HSM Simulator
    cmds:
    - |
      echo "Setting up port forwarding for Sofa, Keycloak, Audit Service, and HSM Simulator..."
      echo "Sofa will be available at: http://localhost:{{.SOFA_PORT}}"
      echo "Keycloak will be available at: http://localhost:{{.KEYCLOAK_PORT}}"
      echo "Audit Service will be available at: http://localhost:{{.AUDIT_PORT}}"
      echo "HSM Simulator will be available at: http://localhost:{{.HSM_PORT}}"
      echo "Keycloak admin console: http://localhost:{{.KEYCLOAK_PORT}}/admin (admin/admin)"
      echo ""
      echo "Press Ctrl+C to stop port forwarding"
      echo ""

      # Start port forwards in background
      kubectl port-forward svc/{{.ENVIRONMENT}}-sofa-service {{.SOFA_PORT}}:80 & 
      SOFA_PF_PID=$!

      kubectl port-forward svc/{{.ENVIRONMENT}}-keycloak-service {{.KEYCLOAK_PORT}}:8080 &
      KC_PF_PID=$!

      kubectl port-forward svc/{{.ENVIRONMENT}}-audit-service {{.AUDIT_PORT}}:80 &
      AUDIT_PF_PID=$!

      kubectl port-forward svc/{{.ENVIRONMENT}}-hsm-simulator {{.HSM_PORT}}:8080 &
      HSM_PF_PID=$!

      # Set up trap to kill background processes on exit
      trap "kill $SOFA_PF_PID $KC_PF_PID $AUDIT_PF_PID $HSM_PF_PID" EXIT INT TERM

      # Keep script running
      echo "Port forwarding active. Press Ctrl+C to exit."
      tail -f /dev/null

  # Cluster and image management tasks
  create-cluster:
    desc: Create a Kind cluster if it doesn't exist
    cmds:
    - |
      if ! kind get clusters | grep -q {{.CLUSTER_NAME}}; then
        echo "Creating Kind cluster..."
        kind create cluster --name {{.CLUSTER_NAME}} --config kind-config.yaml
      else
        echo "Kind cluster already exists, skipping creation."
      fi

  load-image-sofa:
    desc: Load the Sofa image into the Kind cluster
    deps: [ build-sofa, create-cluster ]
    cmds:
    - echo "Loading Sofa image into Kind cluster..."
    - kind load docker-image {{.IMAGE_NAME}} --name {{.CLUSTER_NAME}}

  load-image-audit:
    desc: Load the Audit Service image into the Kind cluster
    deps: [ build-audit, create-cluster ]
    cmds:
    - echo "Loading Audit Service image into Kind cluster..."
    - kind load docker-image {{.AUDIT_IMAGE_NAME}} --name {{.CLUSTER_NAME}}

  load-image-hsm:
    desc: Load the HSM Simulator image into the Kind cluster
    deps: [ build-hsm, create-cluster ]
    cmds:
    - echo "Loading HSM Simulator image into Kind cluster..."
    - kind load docker-image {{.HSM_IMAGE_NAME}} --name {{.CLUSTER_NAME}}

  # Generic task to load all images
  load-image:
    desc: Load all images into the Kind cluster
    deps: [ load-image-sofa, load-image-audit, load-image-hsm ]
    cmds:
    - echo "All images loaded into the cluster"

  apply-manifests:
    desc: Apply all Kubernetes manifests using Kustomize
    deps: [ load-image ]
    cmds:
    - echo "Applying Kubernetes resources using Kustomize for {{.ENVIRONMENT}} environment..."
    - kubectl apply -k k8s/overlays/{{.ENVIRONMENT}}
    - |
      echo "Waiting for services to be ready..."
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-couchdb --timeout=90s || true
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-sofa --timeout=90s || true
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-keycloak --timeout=120s || true

      echo "Services are available in the cluster. Use port-forwarding to access them."
      echo "Run 'task port-forward' to access the services."

  apply-dev:
    desc: Apply the dev overlay with extra validation
    cmds:
    - |
      echo "Validating kustomize manifests before applying..."

      # Check if kustomize can build the manifests without errors
      if ! kubectl kustomize k8s/overlays/dev > /dev/null; then
        echo "❌ Error in kustomize build. Please check your manifests."
        exit 1
      fi

      echo "✅ Kustomize validation passed"

      # Apply the dev overlay
      echo "Applying dev overlay..."
      kubectl apply -k k8s/overlays/dev

      if [ $? -eq 0 ]; then
        echo "✅ Successfully applied dev overlay"
        
        echo "Waiting for HSM simulator to be ready..."
        kubectl wait --for=condition=available deployment/dev-hsm-simulator --timeout=60s || true
        
        echo "Waiting for Sofa to be ready..."
        kubectl wait --for=condition=available deployment/dev-sofa --timeout=60s || true
        
        echo "Waiting for CouchDB to be ready..."
        kubectl wait --for=condition=available deployment/dev-couchdb --timeout=90s || true
        
        echo "Waiting for Keycloak to be ready..."
        kubectl wait --for=condition=available deployment/dev-keycloak --timeout=120s || true
        
        echo "All services should now be available."
        echo "Run 'task port-forward-all' to access all services."
      else
        echo "❌ Failed to apply dev overlay"
        exit 1
      fi

  enable-audit:
    desc: Enable audit logging in SOFA by configuring it to use the audit service
    cmds:
    - |
      echo "Patching SOFA configuration to enable audit logging..."
      kubectl patch configmap {{.ENVIRONMENT}}-sofa-config -p '{"data":{"audit_enabled":"true","audit_log_service_url":"http://{{.ENVIRONMENT}}-audit-service/audit"}}'
      echo "Restarting SOFA to apply changes..."
      kubectl rollout restart deployment/{{.ENVIRONMENT}}-sofa
      kubectl wait --for=condition=available deployment/{{.ENVIRONMENT}}-sofa --timeout=60s
      echo "Audit logging has been enabled in SOFA"

  setup:
    desc: Complete setup - build, create cluster, load image, and apply manifests
    deps: [ build, load-image, apply-manifests ]
    cmds:
    - |
      # Skip Keycloak connectivity checks during setup for now
      echo "Setup complete!"
      echo "To access the services, run: task port-forward"
      echo ""
      echo "Services will be available at:"
      echo "  - Sofa: http://localhost:{{.SOFA_PORT}}"
      echo "  - Keycloak: http://localhost:{{.KEYCLOAK_PORT}}"
      echo ""
      echo "Keycloak admin console will be available at:"
      echo "  http://localhost:{{.KEYCLOAK_PORT}}/admin"
      echo "  Username: admin"
      echo "  Password: admin"

  default:
    desc: Display help information
    cmds:
    - task --list

  test:auth:unit:
    desc: Run authorization unit tests
    dir: sofa
    cmds:
    - cargo test auth::tests --verbose

  test:auth:integration:
    desc: Run authorization integration tests
    dir: sofa
    cmds:
    - cargo test authorization_integration_tests --verbose

  test:auth:container:
    desc: Test authorization in container
    cmds:
    - |
      echo "Building test container..."
      cd sofa && docker build -t sofa:auth-test .

      echo "Testing unauthorized access..."
      docker run -d --name sofa-auth-test -p 3003:3000 \
        -e ENVIRONMENT=test \
        -e SOFA_AUTH_ENABLED=true \
        -e SOFA_AUTH_AUTHORIZATION="$(cat k8s/overlays/dev/sofa-config-patch.yaml | yq eval '.data.auth_authorization' -)" \
        sofa:auth-test

      sleep 5

      # Test unauthorized access
      response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3003/_all_dbs)
      echo "Response: $response"
      [ "$response" = "401" ] && echo "✓ Unauthorized access blocked" || (echo "✗ Expected 401, got $response" && exit 1)

      # Test invalid token
      response=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer invalid" http://localhost:3003/_all_dbs)
      echo "Invalid token response: $response"
      [ "$response" = "401" ] && echo "✓ Invalid token rejected" || (echo "✗ Expected 401, got $response" && exit 1)

      echo "✓ All container tests passed"
      docker stop sofa-auth-test && docker rm sofa-auth-test

  test:auth:cluster:
    desc: Test authorization in cluster
    deps: [ cluster:deploy:dev ]
    cmds:
    - |
      echo "Testing authorization in cluster..."
      kubectl port-forward service/dev-sofa-service 3004:80 &
      FORWARD_PID=$!
      sleep 10

      # Test endpoints
      endpoints=("_all_dbs" "_session" "nonexistent/path")
      for endpoint in "${endpoints[@]}"; do
        echo "Testing /$endpoint..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3004/$endpoint)
        [ "$response" = "401" ] && echo "✓ $endpoint blocked" || (echo "✗ $endpoint: expected 401, got $response" && kill $FORWARD_PID && exit 1)
      done

      kill $FORWARD_PID
      echo "✓ All cluster authorization tests passed"

  test:auth:all:
    desc: Run all authorization tests
    cmds:
    - task: test:auth:unit
    - task: test:auth:integration
    - task: test:auth:container
    - task: test:auth:cluster

  test:auth:config:
    desc: Validate authorization configurations
    cmds:
    - |
      echo "Validating authorization configurations..."

      configs=(
        "k8s/overlays/dev/sofa-config-patch.yaml"
        "k8s/overlays/prod/sofa-config-patch.yaml"
        "k8s/base/sofa/sofa-config.yaml"
      )

      for config in "${configs[@]}"; do
        echo "Checking $config..."
        
        # Extract and validate YAML
        yq eval '.data.auth_authorization' "$config" > temp_auth.yaml
        
        # Check required fields
        [ "$(yq eval '.default_action' temp_auth.yaml)" = "deny" ] && echo "✓ default_action: deny" || (echo "✗ Missing default_action: deny" && exit 1)
        [ "$(yq eval '.rules | length' temp_auth.yaml)" -gt 0 ] && echo "✓ Has authorization rules" || (echo "✗ No authorization rules" && exit 1)
        
        rm temp_auth.yaml
      done

      echo "✓ All configurations valid"

  test:auth:security:
    desc: Run security validation checks
    cmds:
    - |
      echo "Running security checks..."

      # Check for secure defaults
      grep -r "default_action: deny" k8s/ || (echo "✗ Found non-deny default actions" && exit 1)
      echo "✓ All configs use deny by default"

      # Check production restrictions
      if grep -A 20 "production-user-access" k8s/overlays/prod/sofa-config-patch.yaml | grep -q "DELETE"; then
        echo "✗ Production allows DELETE operations"
        exit 1
      fi
      echo "✓ Production properly restricts DELETE"

      echo "✓ All security checks passed"
